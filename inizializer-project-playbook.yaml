---
# T√≠tulo: Playbook para crear PAT de usuario, repositorio, webhook y notificar
# Ejecutable desde AAP/AWX
- name: Crear PAT de usuario, repositorio, webhook y notificar
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    # --- Variables de Entrada ---
    # El token que tiene permisos de administrador para crear OTROS tokens y repos.
    # git_token: "..." 
    
    # Par√°metros de Repositorio
    # git_user: "mi_usuario"
    # grupo: "mi_org"
    repo_base: "template-ansible-playbooks"
    repo_base_branch: develop
    # repo_nuevo: "ansible-playbook-example"
    # tipo_repositorio: "gitlab" #|"github" | "gitlab" | "gitea"
    # git_host: "gitea.miempresa.com" #"api.github.com" # | "gitlab.com" | "gitea.miempresa.com"
    
    # Par√°metros de Webhook
    webhook_events: ["push", "pull_request"]

    # Par√°metros de Comunicaci√≥n
    # smtp_to: "equipo@miempresa.com"
    # slack_channel: "#notificaciones-repos"
    # slack_api_token: "xoxb-..." 
    # smtp_host: "smtp.miempresa.com"
    # smtp_user: "automation@miempresa.com"
    # smtp_password: "..."

    # Rutas y URLs
    local_path: "/tmp/{{ repo_nuevo }}_clone"
    
    # Definiremos esta variable para que todas las tareas usen el nuevo token.
    # newly_created_pat: ""
    validate_certs: false

    # teams_webhook_url: "https://tuhost.webhook.office.com/webhookb2/..."
    notification_title: "‚úÖ Playbook Finalizado Exitosamente"
    notification_text: "El playbook de configuraci√≥n ha terminado en el servidor {{ inventory_hostname }}."

    job_Template_lifecycle: Demo Job Template
  tasks:

    # =========================================================================
    # 0. Tareas de Creaci√≥n del Token de Acceso Personal (PAT)
    #    IMPORTANTE: Este token se usar√° para el resto de las operaciones.
    # =========================================================================

    # # --- 0.1 GitHub PAT Creation (using URI to simulate PAT creation for auth user)
    # - name: 0.1 Crear PAT de Usuario en GitHub
    #   ansible.builtin.uri:
    #     url: "https://{{ git_host }}/user/tokens"
    #     method: POST
    #     headers:
    #       Authorization: "token {{ git_token }}"
    #     body_format: json
    #     body:
    #       scopes: ["repo", "workflow"] # Alcance amplio para crear y modificar repos
    #       note: "PAT for {{ repo_nuevo }}"
    #     status_code: [201]
    #     validate_certs: "{{validate_certs}}"
    #   when: tipo_repositorio == 'github'
    #   register: pat_creation_result_github
      
    # - name: 0.1.1 Setear nuevo PAT para GitHub
    #   ansible.builtin.set_fact:
    #     newly_created_pat: "{{ pat_creation_result_github.json.token }}"
    #   when: tipo_repositorio == 'github' and pat_creation_result_github is succeeded


    # # --- 0.2 GitLab PAT Creation (using dedicated module)
    # - name: 0.2 Crear PAT de Usuario en GitLab
    #   community.general.gitlab_group_access_token:
    #     api_url: "https://{{ git_host }}"
    #     api_token: "{{ git_token }}"
    #     user_id: "{{ git_user }}" # Asumiendo que 'usuario' es el propietario de la API token
    #     name: "PAT for {{ repo_nuevo }}"
    #     scopes: ["api", "read_repository", "write_repository"] # Alcance amplio para crear y modificar repos
    #     state: present
    #   when: tipo_repositorio == 'gitlab'
    #   register: pat_creation_result_gitlab

    # - name: 0.2.1 Setear nuevo PAT para GitLab
    #   ansible.builtin.set_fact:
    #     newly_created_pat: "{{ pat_creation_result_gitlab.access_token }}"
    #   when: tipo_repositorio == 'gitlab' and pat_creation_result_gitlab is succeeded


    # # --- 0.3 Gitea PAT Creation (using URI)
    # - name: Create PAT in GITEA for lab-user
    #   ansible.builtin.uri:
    #     url: "https://{{ git_host }}/api/v1/users/{{ git_user }}/tokens"
    #     method: POST
    #     body_format: json
    #     user: "{{ git_user }}"
    #     password: "{{ git_token }}"
    #     force_basic_auth: yes
    #     body:
    #       name: "PAT for lab2"
    #       scopes: ["write:repository", "write:issue", "write:activitypub", "write:misc", "write:notification" , "write:organization", "write:package", "write:user"] # Alcance amplio
    #     status_code: [201]
    #     validate_certs: "{{validate_certs}}"
    #   when: tipo_repositorio == 'gitea'
    #   register: pat_creation_result_gitea

    # - name: 0.3.1 Setear nuevo PAT para Gitea
    #   ansible.builtin.set_fact:
    #     newly_created_pat: "{{ pat_creation_result_gitea.json.sha1 }}"
    #   when: tipo_repositorio == 'gitea' and pat_creation_result_gitea is succeeded

    - name: 0.3.1 Setear nuevo PAT para Gitea
      ansible.builtin.set_fact:
        newly_created_pat: "{{ git_token }}"

    - name: "Get the Authentication Token for the future requests"
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}/api/gateway/v1/tokens/"
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        method: POST
        force_basic_auth: true
        validate_certs: "{{ aap_validate_certs }}"
        status_code: 201
      register: authtoken_res

    - name: "Set the oauth token to be used since now"
      ansible.builtin.set_fact:
        aap_token: "{{ authtoken_res.json.token }}"
        aap_oauthtoken_url: "{{ authtoken_res.json.url }}"

    - name: ‚úÖ Wait for the URL to be available (HTTP 200)
      ansible.builtin.uri:
        url: "https://{{aap_hostname}}/api/controller/v2/job_templates/?search={{job_Template_lifecycle| urlencode}}"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        force_basic_auth: yes  # Required for basic auth
        validate_certs:  "{{ aap_validate_certs }}"    # Set to 'no' if using self-signed certs (not recommended for production)
        status_code: 200
        return_content: yes
      register: aap_job_template

    - name: "Set the oauth token to be used since now"
      ansible.builtin.set_fact:
        aap_job_template_content: "{{ aap_job_template.content }}"

    - name: "Set the oauth token to be used since now"
      ansible.builtin.set_fact:
        aap_job_template_content_results: "{{ aap_job_template_content.results }}"

    - name: 4. Display Recovered Information
      ansible.builtin.debug:
        msg: "{{aap_job_template_content_results[0].related.webhook_key}}"

    - name: ‚úÖ Wait for the URL to be available (HTTP 200)
      ansible.builtin.uri:
        url: "https://{{aap_hostname}}/{{aap_job_template_content_results[0].related.webhook_key}}"
        method: GET
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        force_basic_auth: yes  # Required for basic auth
        validate_certs:  "{{ aap_validate_certs }}"    # Set to 'no' if using self-signed certs (not recommended for production)
        status_code: 200
        return_content: yes
      register: aap_job_template_webhook_key

    - name: 4. Display Recovered Information
      ansible.builtin.debug:
        msg: "{{aap_job_template_webhook_key.webhook_key}}"

    - name: 4. Display Recovered Information
      ansible.builtin.debug:
        msg: "{{aap_job_template_webhook_key.webhook_receiver}}"

    - name: "Delete the Authentication Token used"
      ansible.builtin.uri:
        url: "https://{{ aap_hostname }}{{aap_oauthtoken_url }}"
        user: "{{ aap_username }}"
        password: "{{ aap_password }}"
        method: DELETE
        force_basic_auth: true
        validate_certs: "{{ aap_validate_certs }}"
        status_code: 204
      when: aap_oauthtoken_url is defined

      

    # - name: 1. Use controller_api lookup to filter Job Templates by Name
    #   # Path: 'job_templates' is the API endpoint.
    #   # Query: The 'name' parameter filters the results on the server-side.
    #   set_fact:
    #     jt_lookup_result: >
    #       {{ lookup(
    #         'ansible.controller.controller_api',
    #         'job_templates',
    #         query_parameters={
    #           'name': 'Demo Job Template'
    #         },
    #         host=aap_hostname,
    #         username=aap_username,
    #         password=aap_password,
    #         verify_ssl=aap_validate_certs
    #       ) }}

    # - name: 4. Display Recovered Information
    #   ansible.builtin.debug:
    #     msg: "{{jt_lookup_result}}"

    # https://example-ansible-automation-platform.apps-crc.testing/api/controller/v2/job_templates/7/webhook_key/

    # =========================================================================
    # 1. Tareas de Creaci√≥n de Repositorio y Webhook (Usando el nuevo PAT)
    # =========================================================================

    - name: 1.1 Crear repositorio en GitHub desde plantilla
      community.general.github_repo:
        api_url: "https://{{ git_host }}"
        api_token: "{{ newly_created_pat }}" # <--- USANDO EL NUEVO PAT
        name: "{{ repo_nuevo }}"
        organization: "{{ grupo }}"
        state: "present"
      when: tipo_repositorio == 'github' and newly_created_pat is defined
      register: github_result
      # ... (Resto de tareas de GitHub, GitLab y Gitea siguen, usando {{ newly_created_pat }} en lugar de {{ admin_token_repositorio }}) ...

    # =========================================================================
    # 1. Tareas de Creaci√≥n (GitHub) - Continuaci√≥n
    # =========================================================================

    - name: 1.2 Crear Webhook en GitHub
      community.general.github_webhook:
        token: "{{ newly_created_pat }}"
        repo: "{{ grupo }}/{{ repo_nuevo }}"
        url: "https://{{ aap_hostname }}{{ webhook_events }}"
        secret: "{{ aap_job_template_webhook_key.webhook_key }}"
        events: "{{ webhook_events }}"
        state: present
      when: tipo_repositorio == 'github' and github_result is succeeded


    # =========================================================================
    # 2. Tareas de Creaci√≥n (GitLab) - Continuaci√≥n
    # =========================================================================
    
    - name: 2.1 Crear repositorio en GitLab desde plantilla
      community.general.gitlab_project:
        api_url: "https://{{ git_host }}"
        api_token: "{{ newly_created_pat }}"
        name: "{{ repo_nuevo }}"
        path_with_namespace: "{{ grupo }}/{{ repo_nuevo }}"
        state: "present"
      when: tipo_repositorio == 'gitlab' and newly_created_pat is defined
      register: gitlab_result

    - name: 2.2 Crear Webhook en GitLab
      community.general.gitlab_hook:
        api_token: "{{ newly_created_pat }}"
        project_id: "{{ grupo }}/{{ repo_nuevo }}"
        url: "https://{{ aap_hostname }}{{ webhook_events }}"
        token: "{{ aap_job_template_webhook_key.webhook_key }}"
        push_events: true
        merge_requests_events: true
        state: present
      when: tipo_repositorio == 'gitlab' and gitlab_result is succeeded

    # =========================================================================
    # 3. Tareas de Creaci√≥n (Gitea) - Continuaci√≥n
    # =========================================================================
    
    - name: 3.1 Crear el nuevo repositorio vac√≠o en Gitea (API)
      ansible.builtin.uri:
        url: "https://{{ git_host }}/api/v1/user/repos"
        method: POST
        headers:
          Authorization: "token {{ newly_created_pat }}" # <--- USANDO EL NUEVO PAT
        body_format: json
        body:
          name: "{{ repo_nuevo }}"
          owner: "{{ grupo }}"
          private: false
        status_code: [201]
        validate_certs: "{{validate_certs}}"
      when: tipo_repositorio == 'gitea' and newly_created_pat is defined
      register: gitea_create_result

    - name: 3.3 Crear Webhook en Gitea (API)
      ansible.builtin.uri:
        url: "https://{{ git_host }}/api/v1/repos/{{ grupo }}/{{ repo_nuevo }}/hooks"
        method: POST
        headers:
          Authorization: "token {{ newly_created_pat }}" # <--- USANDO EL NUEVO PAT
        body_format: json
        body:
          type: "gogs"
          config:
            url: "https://{{ aap_hostname }}{{ webhook_events }}"
            content_type: "json"
            secret: "{{ aap_job_template_webhook_key.webhook_key }}"
          authorization_header: "Bearer {{ aap_job_template_webhook_key.webhook_key }}"
          events: "{{ webhook_events }}"
          active: true
        status_code: [201]
        validate_certs: "{{validate_certs}}"
      when: tipo_repositorio == 'gitea' and gitea_create_result is succeeded

    # --- CLONACI√ìN Y PUSH DEL CONTENIDO PARA GITEA ---
    # Nota: Aqu√≠ se usar√° el PAT para autenticarse en las URLs de clonaci√≥n


    - name: 1.3 Establecer URL final
      ansible.builtin.set_fact:
        repo_final_url: "{{ git_host }}/{{ grupo }}/{{ repo_nuevo }}"
    
    - name: 3.4 Clonar el repositorio base localmente
      ansible.builtin.git:
        # La URL de clonaci√≥n debe usar el nuevo PAT
        repo: "https://{{ newly_created_pat }}@{{ git_host }}/{{ grupo }}/{{ repo_base }}.git"
        dest: "{{ local_path }}"
        version: "{{ repo_base_branch }}"
        clone: yes
        update: yes
      when: repo_final_url is defined
      
    # ... (Resto de tareas de Gitea - limpieza y push, usando el nuevo PAT en la URL del push) ...

    - name: 3.5 Eliminar el directorio .git del clon para un nuevo historial
      ansible.builtin.file:
        path: "{{ local_path }}/.git"
        state: absent
      when: repo_final_url is defined

    - name: 3.6 Inicializar nuevo repositorio Git, agregar contenido y commit
      ansible.builtin.command: "{{ item }}"
      args:
        chdir: "{{ local_path }}"
      loop:
        - git init
        - git add .
        - git config --global user.email "{{git_user}}@example.com"
        - git config --global user.name "{{git_user}}"
        - git config http.sslVerify false
        - git commit -m 'Initial commit from template {{ repo_base }}'
      when: repo_final_url is defined

    - name: 3.7 A√±adir remoto y enviar el contenido al nuevo repositorio
      ansible.builtin.command: "{{ item }}"
      args:
        chdir: "{{ local_path }}"
      loop:
        # La URL de push debe usar el nuevo PAT
        - git remote add origin https://{{ newly_created_pat }}@{{ repo_final_url }}.git
        - git push -u origin master
      when: repo_final_url is defined

    - name: 3.8 Limpiar el directorio temporal
      ansible.builtin.file:
        path: "{{ local_path }}"
        state: absent
      when: repo_final_url is defined

    # =========================================================================
    # 4. Tareas de Comunicaci√≥n
    # =========================================================================
    - name: 4.1 ENVIAR NOTIFICACI√ìN POR EMAIL (ansible.builtin.mail)
      ansible.builtin.mail:
        host: "{{ smtp_host }}"
        port: "{{ smtp_port|int }}"
        username: "{{ smtp_user }}"
        password: "{{ smtp_password }}"
        to: "{{ smtp_to }}"
        subject: "‚úÖ Repositorio Creado [{{ tipo_repositorio | upper }}]: {{ repo_nuevo }}"
        body: |
          Hola,

          Se ha completado la automatizaci√≥n.
          - URL de Acceso: {{ repo_final_url }}
          - Webhook (https://{{ aap_hostname }}{{ webhook_events }}) configurado.
          - PAT de usuario creado para este proceso.

          üö® ¬°ADVERTENCIA DE SEGURIDAD! El nuevo PAT de usuario tiene alcance amplio y es visible 
          en los logs de la ejecuci√≥n (variable 'newly_created_pat'). Deber√≠a ser almacenado 
          inmediatamente en un gestor de secretos (Vault) y luego borrado de la plataforma si no es necesario.

          Saludos,
          Plataforma de Automatizaci√≥n AWX/AAP
      when: repo_final_url is defined and repo_final_url != "" and smtp_host is defined and "email" in canales_comunicacion

    - name: 4.2 ENVIAR NOTIFICACI√ìN POR SLACK (community.general.slack)
      community.general.slack:
        token: "{{ slack_api_token }}"
        channel: "{{ slack_channel }}"
        msg: "üöÄ *Nuevo Repositorio Creado en {{ tipo_repositorio | upper }}*\n- *Nombre:* `{{ repo_nuevo }}`\n- *URL:* <{{ repo_final_url }}|Abrir Repositorio>\n- *PAT Creado:* Nuevo PAT de usuario generado para la automatizaci√≥n.\n*(Recuperar el valor del PAT de los logs de AWX/AAP)*"
        username: "AWX Automation"
        icon_emoji: ":rocket:"
      when: repo_final_url is defined and repo_final_url != "" and slack_api_token is defined and "slack" in canales_comunicacion

    - name: Enviar mensaje a Microsoft Teams
      ansible.builtin.uri:
        url: "{{ teams_webhook_url }}"
        method: POST
        body_format: json
        status_code: 200
        body:
          title: "{{ notification_title }}"
          text: "{{ notification_text }}"
        validate_certs: "{{validate_certs}}"
      delegate_to: localhost
      when: repo_final_url is defined and repo_final_url != "" and teams_webhook_url is defined and "teams" in canales_comunicacion